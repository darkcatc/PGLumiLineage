# LLM分析器 (llm_analyzer) 设计决策文档

**最后更新时间**：2025-05-16

## 模块概述

LLM分析器是PGLumiLineage项目的核心组件之一，负责利用大语言模型（LLM）分析SQL模式、视图定义及函数逻辑，提取细粒度至列级别的数据血缘关系。该模块将SQL及相关元数据作为输入，通过精心设计的提示词引导LLM进行分析，并将结果转换为结构化的数据血缘关系信息。

## 关键设计决策

### 1. LLM技术选型

**决策**：初期选择阿里云通义千问（Qwen）作为主要的LLM模型。

**原因**：
- Qwen在中文语境下表现优秀，能更好地理解中文SQL注释和业务逻辑
- 提供OpenAI兼容API，便于集成和使用
- 在结构化数据处理方面具有较好的能力
- 相比其他模型，在处理复杂SQL分析任务时具有更好的性价比

**替代方案考虑**：
- OpenAI GPT系列：虽然功能强大，但在中文处理上可能不如Qwen，且API访问成本较高
- 本地部署的开源模型：虽然可控性高，但需要更多的计算资源和维护成本

### 2. 提示词工程设计

**决策**：采用结构化、指令明确的提示词设计，包含系统提示和用户提示两部分。

**原因**：
- 结构化的提示词能够引导LLM生成格式一致的输出，便于后续处理
- 明确的指令能够提高LLM分析的准确性和一致性
- 系统提示和用户提示分离，便于维护和优化

**关键优化点**：
- 在提示词中明确要求输出JSON格式，并详细定义了JSON结构
- 对UNION操作、字面量、复杂表达式等特殊情况提供了明确的处理指导
- 要求在transformation_logic中提供完整的表达式，包含具体字段名而不使用省略号
- 添加对SQL片段分析的支持，包括is_sql_fragment和fragment_analysis_notes字段
- 强调transformation_logic与derivation_type的组合使用，提供更完整的血缘信息

### 3. 元数据上下文构建

**决策**：为LLM提供丰富的元数据上下文，包括表结构、视图定义等信息。

**原因**：
- LLM需要足够的上下文信息才能准确理解SQL的语义和数据流向
- 元数据上下文能够帮助LLM识别列级别的数据血缘关系
- 完整的表结构信息有助于LLM理解数据类型和约束条件

**实现方式**：
- 从元数据存储中获取SQL相关的表、视图、列信息
- 构建结构化的元数据上下文字典，包含源数据库名称、表元数据、视图定义等
- 对于未找到元数据的表，计划将其标记为临时表或未解析表，并在上下文中说明

### 4. 异步处理架构

**决策**：采用异步处理架构，使用asyncio和asyncpg进行数据库操作。

**原因**：
- LLM API调用和数据库操作都是I/O密集型任务，适合使用异步处理
- 异步架构能够提高系统的并发处理能力，更高效地利用资源
- 与项目其他模块保持一致的技术栈，便于集成和维护

**实现细节**：
- 使用asyncio.gather并发处理多个SQL模式的分析任务
- 实现任务队列和批处理机制，避免API限流问题
- 设计重试机制，处理临时性的API调用失败

### 5. 结果解析与存储策略

**决策**：将LLM返回的结果解析为结构化的JSON对象，并存储到数据库中。

**原因**：
- 结构化的数据便于后续的图谱构建和查询
- 存储到数据库中便于追踪和管理分析结果
- JSON格式具有良好的灵活性，能够适应不同的血缘关系表示

**实现挑战与解决方案**：
- LLM可能返回非标准JSON：实现了健壮的解析逻辑，能够处理各种格式问题
- 大型SQL可能导致上下文溢出：采用分段处理策略，将复杂SQL拆分为多个部分分析
- 解析错误处理：设计了详细的错误记录机制，便于调试和优化

## 演进历史

### 初始版本 (2025-03)

- 基本的LLM分析功能实现
- 简单的提示词设计
- 支持基本的SQL语句分析

### 第二版本 (2025-04)

- 改进提示词设计，增加对复杂SQL结构的支持
- 优化元数据上下文构建逻辑
- 增强结果解析的健壮性

### 当前版本 (2025-05)

- 全面优化提示词，特别是对UNION操作的处理
- 改进transformation_logic的表示方式，要求包含完整字段名
- 添加对SQL片段分析的支持
- 计划增加对临时表和未解析表的处理

## 未来计划

### 短期计划

1. **临时表处理优化**：
   - 实现对未找到元数据的表的标记和处理
   - 在元数据上下文中为此类对象创建条目，标记为临时表或未解析表

2. **提示词持续优化**：
   - 根据实际分析结果，持续优化提示词设计
   - 增加对更多复杂SQL结构的支持

3. **批处理机制改进**：
   - 优化批处理逻辑，提高系统吞吐量
   - 实现更智能的任务调度策略

### 中长期计划

1. **多模型支持**：
   - 增加对其他LLM模型的支持
   - 实现模型选择和结果比对功能

2. **自适应分析**：
   - 根据SQL复杂度自动调整分析策略
   - 实现分析结果质量评估和自动优化

3. **业务规则提取**：
   - 扩展分析范围，不仅提取数据血缘，还提取业务规则
   - 构建更丰富的知识图谱

## 技术债务与挑战

1. **大型SQL处理**：
   - 当前对于非常复杂的SQL语句，可能会遇到上下文长度限制
   - 需要实现更智能的SQL拆分和上下文管理策略

2. **结果一致性**：
   - LLM的输出可能存在一定的随机性，影响结果的一致性
   - 需要设计更严格的输出格式约束和验证机制

3. **性能优化**：
   - LLM API调用是系统的性能瓶颈
   - 需要实现更高效的缓存和批处理机制

## 关键接口

### 输入接口

- **fetch_metadata_context_for_sql**：从元数据存储中获取SQL相关的元数据上下文
- **construct_prompt_for_qwen**：构造发送给LLM的提示词

### 输出接口

- **parse_llm_response**：解析LLM返回的响应，提取结构化的血缘关系信息
- **update_sql_pattern_analysis_result**：更新SQL模式的分析结果到数据库

## 依赖关系

- **内部依赖**：
  - common模块：配置管理、数据库连接等
  - sql_normalizer模块：提供SQL模式信息

- **外部依赖**：
  - asyncpg：异步PostgreSQL客户端
  - openai：OpenAI兼容API客户端
  - sqlglot：SQL解析工具
  - json：JSON处理
